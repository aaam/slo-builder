groups:
- name: slo-builder
  rules:
  - record: job:slo_definition:none
    expr: "1"
    labels:
      budget: "0.100000"
      deadline: 2h
      name: MarkPaymentsAsPaidMeetsDeadline
      throughput: |
        sum by (namespace, release) (
          rate(paysvc_mark_payments_as_paid_marked_as_paid_total[1m])
        ) > 0
      volume: |
        1.5 * max_over_time(
          (
            sum by (namespace, release) (
              increase(paysvc_mark_payments_as_paid_marked_as_paid_total[8h])
            )
          )[60d:1h]
        )
  - record: job:slo_error_budget:ratio
    expr: "0.100000"
    labels:
      name: MarkPaymentsAsPaidMeetsDeadline
  - record: job:slo_batch_volume:max
    expr: |
      1.5 * max_over_time(
        (
          sum by (namespace, release) (
            increase(paysvc_mark_payments_as_paid_marked_as_paid_total[8h])
          )
        )[60d:1h]
      )
    labels:
      name: MarkPaymentsAsPaidMeetsDeadline
  - record: job:slo_batch_throughput_target:max
    expr: job:slo_batch_volume:max / 7200
    labels:
      name: MarkPaymentsAsPaidMeetsDeadline
  - record: job:slo_batch_throughput:interval
    expr: |
      sum by (namespace, release) (
        rate(paysvc_mark_payments_as_paid_marked_as_paid_total[1m])
      ) > 0
    labels:
      name: MarkPaymentsAsPaidMeetsDeadline
  - record: job:slo_batch_error:interval
    expr: "\n1.0 - clamp_max(\n  job:slo_batch_throughput:interval / job:slo_batch_throughput_target:max,\n
      \ 1.0\n)\n\t\t\t"
  - record: job:slo_error:ratio1m
    expr: avg_over_time(job:slo_batch_error:interval[1m])
  - record: job:slo_error:ratio5m
    expr: avg_over_time(job:slo_batch_error:interval[5m])
  - record: job:slo_error:ratio30m
    expr: avg_over_time(job:slo_batch_error:interval[30m])
  - record: job:slo_error:ratio1h
    expr: avg_over_time(job:slo_batch_error:interval[1h])
  - record: job:slo_error:ratio6h
    expr: avg_over_time(job:slo_batch_error:interval[6h])
  - record: job:slo_error:ratio1d
    expr: avg_over_time(job:slo_batch_error:interval[1d])
  - record: job:slo_error:ratio3d
    expr: avg_over_time(job:slo_batch_error:interval[3d])
  - record: job:slo_error:ratio7d
    expr: avg_over_time(job:slo_batch_error:interval[7d])
  - record: job:slo_error:ratio28d
    expr: avg_over_time(job:slo_batch_error:interval[28d])
  - alert: SLOErrorBudgetFastBurn
    expr: "\n(\n  job:slo_error:ratio1h > on(name) (14.4 * job:slo_error_budget:ratio)\nand\n
      \ job:slo_error:ratio5m > on(name) (14.4 * job:slo_error_budget:ratio)\n)\nor\n(\n
      \ job:slo_error:ratio6h  > on(name) (6.0 * job:slo_error_budget:ratio)\nand\n
      \ job:slo_error:ratio30m > on(name) (6.0 * job:slo_error_budget:ratio)\n)\n\t\t\t"
    for: 1m
    labels:
      severity: ticket
  - alert: SLOErrorBudgetSlowBurn
    expr: "\n(\n  job:slo_error:ratio1d > on(name) group_left() (3.0 * job:slo_error_budget:ratio)\nand\n
      \ job:slo_error:ratio2h > on(name) group_left() (3.0 * job:slo_error_budget:ratio)\n)\nor\n(\n
      \ job:slo_error:ratio3d > on(name) group_left() (1.0 * job:slo_error_budget:ratio)\nand\n
      \ job:slo_error:ratio6h > on(name) group_left() (1.0 * job:slo_error_budget:ratio)\n)\n\t\t\t"
    for: 1h
    labels:
      severity: ticket
